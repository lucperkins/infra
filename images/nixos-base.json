{
  "variables": {
    "do_token": "{{env `TF_VAR_do_token`}}",
    "do_region": "sfo2",
    "nix_channel": "nixos-20.03"
  },
  "builders": [
    {
      "type": "digitalocean",
      "api_token": "{{user `do_token`}}",
      "image": "ubuntu-18-04-x64",
      "region": "{{user `do_region`}}",
      "size": "s-1vcpu-1gb",
      "ssh_username": "root",
      "snapshot_regions": [
        "{{user `do_region`}}"
      ],
      "snapshot_name": "{{user `nix_channel`}}-{{timestamp}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "curl https://raw.githubusercontent.com/elitak/nixos-infect/master/nixos-infect | PROVIDER=digitalocean NIX_CHANNEL={{user `nix_channel`}} NO_REBOOT=true bash 2>&1 | tee /var/log/infect.log"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo Rebooting...",
        "reboot &"
      ]
    },
    {
      "type": "shell",
      "pause_before": "10s",
      "timeout": "10s",
      "inline": [
        "echo done provisioning"
      ]
    },
    {
      "type": "file",
      "source": "configuration.nix",
      "destination": "/etc/nixos/configuration.nix"
    }
  ]
}